@page "/serverstatus"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Authorization

@attribute [Authorize(Roles = "Admin")]

@inject site.Services.GameServerService GameServerService
@inject ILogger<Pages.ServerStatus> Logger
@inject IJSRuntime JS

<h3>Game Server Status</h3>

@if (isLoading)
{
    <p>Loading server info...</p>
}
else if (hasError)
{
    <div class="alert alert-danger">
        ⚠️ Failed to retrieve server info. Check logs for details.
    </div>
}
else if (serverInfo == null)
{
    <p>Server is offline or unreachable.</p>
}
else
{
    <p><b>Name:</b> @serverInfo.Name</p>
    <p><b>Map:</b> @serverInfo.Map</p>
    <p><b>Players:</b> @serverInfo.Players / @serverInfo.MaxPlayers</p>
    <p><b>Ping:</b> @serverInfo.Ping ms</p>

    @if (players.Length > 0)
    {
        <h4>Players:</h4>
        <ul>
            @foreach (var p in players)
            {
                <li>@p.Name - @p.Score points - @p.Time.ToString("mm':'ss")</li>
            }
        </ul>
    }
    else
    {
        <p>No players currently connected.</p>
    }
}

@code {
    private QueryMaster.GameServer.ServerInfo? serverInfo;
    private QueryMaster.GameServer.PlayerInfo[] players = Array.Empty<QueryMaster.GameServer.PlayerInfo>();

    private bool isLoading = true;
    private bool hasError = false;
    private bool firstRender = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Logger.LogInformation("🔄 [ServerStatus] Fetching server info...");
            serverInfo = await GameServerService.GetInfoAsync();
            players = await GameServerService.GetPlayersAsync();

            if (serverInfo != null)
            {
                Logger.LogInformation($"✅ Server online: {serverInfo.Name} ({serverInfo.Players}/{serverInfo.MaxPlayers})");
            }
            else
            {
                Logger.LogWarning("⚠️ Server returned null (offline?)");
            }
        }
        catch (Exception ex)
        {
            hasError = true;
            Logger.LogError(ex, "❌ Failed to fetch server info");
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRenderCall)
    {
        if (firstRenderCall)
        {
            firstRender = false;

            // Now that the circuit is alive, we can safely log to browser console
            if (hasError)
            {
                await JS.InvokeVoidAsync("console.error", "❌ Failed to fetch server info (see server logs)");
            }
            else if (serverInfo == null)
            {
                await JS.InvokeVoidAsync("console.warn", "⚠️ Server is offline or returned null");
            }
            else
            {
                await JS.InvokeVoidAsync("console.log", $"✅ Server online: {serverInfo.Name}");
            }
        }
    }
}
